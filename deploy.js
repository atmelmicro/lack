import{App as v,CfnOutput as A,Duration as j,Fn as R,Stack as k,aws_apigatewayv2 as a,aws_apigatewayv2_integrations as x,aws_cloudfront as u,aws_cloudfront_origins as C,aws_lambda as r,aws_lambda_nodejs as I,aws_logs as W}from"aws-cdk-lib";import{readdir as L}from"fs/promises";async function y(e){let t=await L(e,{withFileTypes:!0});if(t.length===0)return[];let n=t.filter(o=>!o.isDirectory()||o.name.startsWith("_")).map(o=>`${e}/${o.name}`),i=(await Promise.all(t.filter(o=>o.isDirectory()).map(o=>y(`${e}/${o.name}`)))).flat();return[...n,...i]}var d={pos$:"post",del$:"delete",put$:"put"};function P(e){return Object.keys(d).find(t=>e.slice(0,4)===t)!==void 0?e.slice(4):e}function M(e){let t=Object.keys(d).find(n=>e.slice(0,4)===n)!==void 0;return console.log(e.slice(0,4)),t&&(e=e.slice(4)),e.endsWith("$index")&&(e=e.slice(0,-6)),e.replaceAll("__","/")}function f(e){let t=M(e);return console.log(t),t.split("/").map(i=>i.split(/(?=\$)/)).flat().filter(i=>i)}function H(e){let t=f(e),n=t.map(i=>i.startsWith("$")?"([^/]+)":i).join("/");return console.log("aa - /"+n," -- ",t),new RegExp("/"+n)}function S(e){return"/"+f(e).map(n=>n.startsWith("$")?`{${n.slice(1)}}`:n).join("/")}function N(e){let t=f(e),n=[];return t.forEach((i,o)=>{i.startsWith("$")&&n.push({i:o,name:i.slice(1)})}),n}async function _(){let e=await y("./out");return(await Promise.all(e.map(t=>import(t).then(n=>Object.keys(n).map(i=>{let o=t.slice(5,-3),c=`${o}/${P(i)}`;return{file:t,func:i,method:d[i.slice(0,4)]??"get",matcher:H(c),paramLocations:N(c),path:o,lambdaMatcher:S(c)}}))))).flat()}import{join as J}from"path";async function T(){let e=new v,t=new k(e,"llrt-example",{env:{region:"eu-central-1"}}),n=new a.HttpApi(t,"HttpApi",{disableExecuteApiEndpoint:!1,corsPreflight:void 0}),i=[],o=(s,p,O,m)=>{let l=new r.Function(t,s,{functionName:s,code:r.Code.fromAsset(p),...$,handler:`index.${O}`,environment:{},runtime:r.Runtime.PROVIDED_AL2,layers:[b]}),w=new x.HttpLambdaIntegration(`${l.node.id}Integration`,l);new a.HttpRoute(t,`${l.node.id}Route`,{httpApi:n,routeKey:a.HttpRouteKey.with(m,a.HttpMethod.ANY),integration:w}),new a.HttpRoute(t,`${l.node.id}ProxyRoute`,{httpApi:n,routeKey:a.HttpRouteKey.with(`${m}/{proxy+}`,a.HttpMethod.ANY),integration:w}),i.push(m)},c=R.select(1,R.split("://",n.apiEndpoint)),b=new r.LayerVersion(t,"LlrtArmLayer",{code:r.Code.fromAsset("./llrt-lambda-arm64.zip"),compatibleRuntimes:[r.Runtime.NODEJS_16_X,r.Runtime.NODEJS_20_X,r.Runtime.NODEJS_20_X,r.Runtime.NODEJS_LATEST,r.Runtime.PROVIDED_AL2],compatibleArchitectures:[r.Architecture.ARM_64]}),$={runtime:r.Runtime.NODEJS_20_X,memorySize:128,timeout:j.seconds(60),bundling:{format:I.OutputFormat.ESM,banner:"import {createRequire} from 'module';const require=createRequire(import.meta.url);",minify:!0,sourceMap:!0},architecture:r.Architecture.ARM_64,logRetention:W.RetentionDays.ONE_DAY},D=await _();for(let s of D)console.log(s),o(s.lambdaMatcher.replaceAll("/","__").replaceAll(/{|}/gi,"-"),J("./lambda",s.path),s.func,s.lambdaMatcher);for(let[s,p]of i.entries())new A(t,`HttpApiOutput${s}`,{value:`${n.apiEndpoint}${p}`});let g="/llrt",h=g.substring(1).replace(/-\//g,""),E=new u.Distribution(t,`${h}Distribution`,{defaultBehavior:{origin:new C.HttpOrigin(c,{protocolPolicy:u.OriginProtocolPolicy.HTTPS_ONLY,originPath:g}),allowedMethods:u.AllowedMethods.ALLOW_ALL,cachePolicy:u.CachePolicy.CACHING_DISABLED}});new A(t,`DistributionOutput${h}`,{value:E.distributionDomainName})}T();
